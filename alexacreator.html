<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8"/>
    <title>Board Game Voice Creator</title>
    <script src="js/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>
</head>
<body>

<header class="d-flex flex-column flex-md-row align-items-md-center p-3 bg-light">
    <div class="pt-md-3 pb-md-4">
        <h1 class="bd-title mt-0">Board Game Voice Creator</h1>
        <p class="bd-lead">This Javascript will convert plain text rulesets to a simple Alexa application.</p>
        <a href="https://solowargamer.github.io/upload_this_package.zip" class="btn btn-lg btn-bd-primary">Download node
            modules for upgrading version to 2.x</a>
    </div>
</header>

<p/>
<div class="row">
    <div class="col-sm-1 col-md-1 col-xl-1 mb-1">
        &nbsp;
    </div>
    <div class="col-sm-8 col-md-8 col-xl-8 mb-8">
        I want this bot type:
        <select id="alexa_type">
            <option selected="selected">Plain vanilla. Minimal components</option>
            <option>Extra features like dice rolling, health tracking and sound effects</option>
            <option>Extra features plus customized graphics</option>
        </select>

        <p/><br/>
        <p/>
        <h4 class="mb-3 bd-text-purple-bright">Enter your rules here:</h4>

        <textarea ID="rules" rows="6" cols="100" placeholder="
!rulenameone
string to search one
string to search two
string to search three
=Final things to say for rule 1

!rulenametwo
string to search four
string to search five
string to search six
=Final things to say for rule 2

!rulenamethree
string to search six
string to search seven
string to search eight
=Final things to say for rule 3
">
</textarea>

        <p class="bd-lead">
            <strong>Format:</strong>
        <p/>
        <strong>!</strong>RuleName<br/>
        Something the user will say to search for this rule<br/>
        <strong>=</strong>The actual rule text goes here
        </p>

        <p/><br/>
        <p/>
        <h4 class="mb-3 bd-text-purple-bright">This is your code for Skills:</h4>

        <textarea ID="skillsFinal" rows="4" cols="100">
</textarea>

        <p/><br/>
        <p/>
        <h4 class="mb-3 bd-text-purple-bright">Your Javascript code for Lambda function:</h4>

        <textarea ID="lambdaFinal" rows="4" cols="100">
</textarea>

        <p/><br/>
        <p/>
        <input type="button" value="Generate Skills and Lambda Code"
               class="btn btn-lg btn-bd-primary mb-3 mb-md-0 mr-md-3" onclick="CreateAlexa();">

    </div>
</div>

<script>

    function CreateAlexa() {

        /* Created by Mitch Ashford, December 2018 */

        const skillTemplate = `
        {
          "name": "%SKILLNAME%",
          "slots": [],
          "samples": [
            %SAMPLES%
          ]
        },
`;

        const lambdaTemplate = `
const %LAMBDA_NAME%Handler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === 'IntentRequest' && handlerInput.requestEnvelope.request.intent.name === '%LAMBDA_NAME%';
    },
    handle(handlerInput) {
        return handlerInput.responseBuilder.speak('%RESPONSE%').withShouldEndSession(false).getResponse();
    },
};
`;

        var importFile = "templates/";

        // These characters are not allowed inside of Skill names
        function ReplaceInvalidChars(sLine) {
            sLine = sLine.replace('!', '').replace('<', '').replace('>', '').replace('&', '').replace('@', '').replace('?', '').replace("'", "").replace('"', '');
            return sLine;
        }

        // Variables
        var sSkills = skillTemplate;
        var sLambdas = lambdaTemplate;
        var sSkillName = '';
        var sSamples = '';
        var sFinalSkillString = '';
        var sFinalLambdaString = '';
        var sFinalLambdaHandlerString = '';

        var textArea = document.getElementById("rules");
        var lineArray = textArea.value.split('\n');
        var iTotalLines = 0;

        // When file is finished reading, process those lines
        for (var val of lineArray) {
            var newLine = val.trim();
            // Found skill name
            if (newLine.indexOf('!') > -1) {
                iTotalLines++;
                // Empty out samples variable
                sSamples = '';
                sSkills = skillTemplate;
                newLine = ReplaceInvalidChars(newLine).replace(' ', '');
                sSkillName = newLine;
                sFinalLambdaHandlerString = sFinalLambdaHandlerString + newLine + 'Handler,\r\n';
                sSkills = sSkills.replace('%SKILLNAME%', newLine);
            }
            // Rule answer spoken to the user
            else if (newLine.indexOf('=') > -1) {
                iTotalLines++;
                newLine = ReplaceInvalidChars(newLine).replace('=', '');
                sLambdas = lambdaTemplate.replace('%RESPONSE%', newLine);
                sLambdas = sLambdas.replace('%LAMBDA_NAME%', sSkillName).replace('%LAMBDA_NAME%', sSkillName);
                sFinalLambdaString = sFinalLambdaString + sLambdas + '\r\n';
                sFinalSkillString = sFinalSkillString + sSkills.replace('%SAMPLES%', sSamples);
            }
            // Key phrases to listen for
            else if (newLine.length > 2) {
                iTotalLines++;
                newLine = ReplaceInvalidChars(newLine).replace(',', '').replace('.', '');
                if (sSamples != '')
                    sSamples = sSamples + ',"' + newLine + '"\r\n';
                else
                    sSamples = '"' + newLine + '"\r\n';
            } else {
            }
        }

/*
        var sK = skillsText.replace('%SKILLS_REPLACE%', sFinalSkillString);
        console.log(sK);
        document.getElementById("skillsFinal").value = sK;

        var sT = document.getElementById("lambdaText").value;
        sT = sT.replace('%LAMBDA_REPLACE%', sFinalLambdaString).replace('%LAMBDA_HANDLERS%', sFinalLambdaHandlerString);
        console.log(sT);
        document.getElementById("lambdaFinal").value = sT;
*/

        var importFileSkills = "";
        var importFileLambda = "";

        var botType = $('#alexa_type').find(":selected").text();
        if (botType.indexOf('Plain vanilla') > -1) {
            importFileSkills = "templates/vanilla_skills.txt";
            importFileLambda = "templates/vanilla_lambda.txt";
        }
        else if (botType.indexOf('dice rolling') > -1) {
            importFileSkills = "templates/extrafeatures_skills.txt";
            importFileLambda = "templates/extrafeatures_lambda.txt";
        }
        else if (botType.indexOf('graphics') > -1) {
            importFileSkills = "templates/graphics_skills.txt";
            importFileLambda = "templates/graphics_lambda.txt";
        }

        var vLA = '';
        var vSK = '';

        // Handle SKILLS template import
        $.ajax({
            'async': false,
            'global': false,
            'url': importFileSkills,
            'dataType': "text",
            'success': function (data) {
                vSK = data.replace('%SKILLS_REPLACE%', sFinalSkillString);
            }
        });

        // Handle LAMBDA template import
        $.ajax({
            'async': false,
            'global': false,
            'url': importFileLambda,
            'dataType': "text",
            'success': function (data) {
                vLA = data.replace('%LAMBDA_REPLACE%', sFinalLambdaString).replace('%LAMBDA_HANDLERS%', sFinalLambdaHandlerString);
            }
        });

        $('#skillsFinal').text(vSK);
        $('#lambdaFinal').text(vLA);

        //console.log(sFinalSkillString);
        //console.log(sFinalLambdaString);
        //console.log(sFinalLambdaHandlerString);
    }

</script>

</body>
